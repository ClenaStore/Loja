<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Clena Foods • Cardápio</title>
  <style>
    :root{
      --bg:#0e0f12; --panel:#14161a; --line:#262b36;
      --brand:#e63946; --brand-2:#ff8f1f;
      --txt:#f7f8fa; --muted:#cbd5e1;
      --shadow:0 10px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,sans-serif;}
    /* Header */
    header{padding:14px 18px;position:sticky;top:0;z-index:50;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      font-weight:800;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow)}
    header img{width:38px;height:38px;border-radius:10px}
    header h1{font-size:18px;margin:0;letter-spacing:.4px;flex:1}
    .btn{border:0;padding:10px 16px;border-radius:12px;
      background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#fff;
      font-weight:700;cursor:pointer;text-align:center;transition:.25s;box-shadow:0 4px 8px rgba(0,0,0,.25)}
    .btn:hover{filter:brightness(1.12);transform:translateY(-2px)}
    .btn.secondary{background:#2b3240;color:var(--txt);box-shadow:none}
    /* Banner */
    .banner{position:relative;width:100%;height:240px;overflow:hidden}
    .banner img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      opacity:0;transition:opacity 1s ease}
    .banner img.active{opacity:1}
    .banner::after{content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.6),transparent)}
    /* Grid */
    .page{padding:20px;display:grid;gap:20px;grid-template-columns:1fr 1fr}
    @media(min-width:900px){.page{grid-template-columns:repeat(3,1fr)}}
    .card{background:#1b1f27;border:1px solid var(--line);border-radius:18px;overflow:hidden;
      display:flex;flex-direction:column;box-shadow:var(--shadow);transition:.25s;cursor:pointer}
    .card:hover{transform:translateY(-4px) scale(1.02)}
    .card img{width:100%;height:160px;object-fit:cover}
    .card .body{padding:14px;display:flex;flex-direction:column;gap:10px;flex:1}
    .card .name{font-weight:800;font-size:16px}
    .card .price{color:#facc15;font-weight:900;font-size:15px}
    .card .btn{margin-top:auto}
    /* Carrinho */
    #cartDrawer{position:fixed;top:0;right:0;bottom:0;width:92vw;max-width:400px;
      background:#161a22;border-left:1px solid var(--line);transform:translateX(100%);
      transition:.35s;display:flex;flex-direction:column;z-index:100;box-shadow:-6px 0 20px rgba(0,0,0,.6)}
    #cartDrawer.open{transform:translateX(0)}
    .drawerHead{padding:18px;font-weight:800;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;font-size:17px}
    .drawerBody{flex:1;overflow:auto;padding:16px;display:grid;gap:14px}
    .cartItem{background:#1f2530;padding:12px;border-radius:12px;display:flex;gap:12px;align-items:center;box-shadow:var(--shadow)}
    .cartItem img{width:52px;height:52px;border-radius:10px;object-fit:cover}
    .cartItem .info{flex:1}
    .cartItem .name{font-weight:700;font-size:15px}
    .cartItem .extras{font-size:12px;color:var(--muted)}
    .cartItem .price{font-weight:800;font-size:15px}
    .drawerFoot{padding:16px;border-top:1px solid var(--line);display:grid;gap:12px}
    #grandTotal{font-size:20px;color:#facc15;font-weight:900}
    /* Barra de resumo (mobile) */
    #cartBar{position:fixed;bottom:0;left:0;right:0;background:var(--brand);
      padding:12px 18px;display:flex;justify-content:space-between;align-items:center;
      font-weight:800;color:#fff;font-size:15px;z-index:90;cursor:pointer;display:none}
    #cartBar span{font-size:16px}
    /* Popup */
    dialog{border:0;border-radius:20px;max-width:520px;width:94%;background:#181c23;
      color:var(--txt);padding:18px;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.65)}
    .media{width:100%;max-height:260px;margin:0 auto 14px auto;border-radius:14px;overflow:hidden;background:#000}
    .media img,.media video{display:block;width:100%;height:100%;object-fit:cover}
    .popup-body h3{margin:0;font-size:20px;font-weight:900}
    .popup-body p{margin:6px 0 12px 0;color:var(--muted);font-size:14px}
    .popup-body strong{font-size:17px;color:#facc15}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:#222730;border:1px solid #2b3240;padding:6px 10px;border-radius:999px;font-size:12px;color:#e2e8f0}
    .comps{display:grid;gap:8px;margin:14px 0}
    .comps label{background:#222730;padding:10px 12px;border-radius:12px;display:flex;
      justify-content:space-between;align-items:center;cursor:pointer;transition:.2s}
    .comps label:hover{background:#2e3648}
    .qtyBox{display:flex;align-items:center;gap:16px;margin:16px 0}
    .qtyBox button{width:42px;height:42px;border-radius:50%;border:0;
      background:var(--brand);color:#fff;font-size:22px;font-weight:bold;cursor:pointer;transition:.25s}
    .qtyBox button:hover{filter:brightness(1.1);transform:scale(1.05)}
    .qtyVal{min-width:36px;text-align:center;font-weight:800;font-size:17px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;background:#0f1115;
      border:1px solid var(--line);color:var(--txt);font-size:15px}
  </style>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/foods/blob/main/paste/ChatGPT%20Image%2027%20de%20ago.%20de%202025,%2019_35_02.png?raw=true" alt="logo">
  <h1>CLENA FOODS</h1>
  <button class="btn secondary" onclick="toggleCart(true)">🛒 <span id="cartBadge">0</span></button>
</header>

<!-- Banner -->
<div class="banner">
  <img src="https://source.unsplash.com/1200x400/?burger" class="active">
  <img src="https://source.unsplash.com/1200x400/?pizza">
  <img src="https://source.unsplash.com/1200x400/?drinks">
</div>

<!-- Produtos -->
<main class="page" id="menuGrid"></main>

<!-- Carrinho -->
<aside id="cartDrawer">
  <div class="drawerHead">
    <span>🛒 Meu Carrinho</span>
    <button class="btn secondary" onclick="toggleCart(false)">✖</button>
  </div>
  <div class="drawerBody" id="cartItems"></div>
  <div class="drawerFoot">
    <div><b>Total:</b> <span id="grandTotal">R$ 0,00</span></div>
    <div style="display:grid;gap:8px">
      <select id="payMethod">
        <option value="">Forma de pagamento</option>
        <option value="pix">PIX</option>
        <option value="credito">Crédito</option>
        <option value="debito">Débito</option>
        <option value="dinheiro">Dinheiro</option>
      </select>
      <div id="trocoBox" style="display:none">
        <label>Troco para: <input id="trocoVal" placeholder="Ex.: 100"/></label>
      </div>
      <input id="clienteNome" placeholder="Seu nome"/>
      <input id="clienteTel" placeholder="WhatsApp"/>
      <textarea id="clienteEnd" placeholder="Endereço completo"></textarea>
      <textarea id="obs" placeholder="Observações"></textarea>
      <button class="btn" onclick="finalizar()">Enviar Pedido</button>
    </div>
  </div>
</aside>

<!-- Barra de resumo mobile -->
<div id="cartBar" onclick="toggleCart(true)">
  <span id="cartCount">0 itens</span>
  <span id="cartTotal">R$ 0,00</span>
</div>

<!-- Popup produto -->
<dialog id="dlgItem">
  <div class="popup-body">
    <div class="media" id="pMedia"></div>
    <h3 id="pName"></h3>
    <p id="pDesc"></p>
    <div id="pIngredients"></div>
    <strong id="pPrice"></strong>
    <div id="compBox"></div>
    <div class="qtyBox">
      <button onclick="changeQty(-1)">-</button>
      <span class="qtyVal" id="pQty">1</span>
      <button onclick="changeQty(1)">+</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <button class="btn" id="btnAddCart">Adicionar</button>
      <button class="btn secondary" onclick="dlgItem.close()">Cancelar</button>
    </div>
  </div>
</dialog>

<script>
/* ====== CONFIG ====== */
const API_URL="https://script.google.com/macros/s/AKfycbwbOlm3qbzOa89xKn9-MBQOnATbYOYGBJS-xMo2ppDEzWlX3qtvLzadysBdvo5o7dui/exec";
let menu=[],complements=[],cart=[],current=null, qty=1;
const $=s=>document.querySelector(s);
const BRL=v=>"R$ "+Number(v||0).toFixed(2).replace(".",",");

/* ====== BANNER ====== */
let bIx=0;const banners=document.querySelectorAll(".banner img");
setInterval(()=>{banners[bIx].classList.remove("active");bIx=(bIx+1)%banners.length;banners[bIx].classList.add("active")},4000);

/* ====== DATA LOAD ====== */
async function loadData(){
  const m=await fetch(API_URL,{method:"POST",body:JSON.stringify({acao:"getMenu"})}).then(r=>r.json()).catch(()=>({ok:false,items:[]}));
  const c=await fetch(API_URL,{method:"POST",body:JSON.stringify({acao:"getComplements"})}).then(r=>r.json()).catch(()=>({ok:false,items:[]}));
  if(m.ok) menu=m.items; if(c.ok) complements=c.items;
  renderMenu();
}

/* ====== GRID ====== */
function renderMenu(){
  const grid=$("#menuGrid");grid.innerHTML="";
  menu.forEach(item=>{
    const el=document.createElement("div");el.className="card";
    el.innerHTML=`
      <img src="${item.img}" alt="">
      <div class="body">
        <div class="name">${item.name}</div>
        <div class="price">${BRL(item.price)}</div>
        <button class="btn addBtn">Adicionar</button>
      </div>`;
    // abrir popup ao clicar no card (imagem/nome/corpo)
    el.addEventListener("click", (e)=> {
      // se clicou no botão, não abre o popup
      if(e.target && e.target.classList.contains("addBtn")) return;
      openItem(item);
    });
    // botão "Adicionar" funciona (adiciona direto)
    el.querySelector(".addBtn").addEventListener("click",(e)=>{
      e.stopPropagation();
      current=item; qty=1;
      addCurrent({fromPopup:false}); // sem complements/qty custom
    });
    grid.appendChild(el);
  });
}

/* ====== POPUP ====== */
function openItem(item){
  current=item; qty=1;
  // mídia: vídeo (se houver) ou imagem
  const media=$("#pMedia");
  const vid = item.video || item.videoUrl || item.media?.video;
  media.innerHTML = vid
    ? `<video src="${vid}" controls playsinline></video>`
    : `<img src="${item.img}" alt="">`;

  $("#pName").textContent=item.name||"";
  $("#pDesc").textContent=item.desc||"";
  $("#pPrice").textContent=BRL(item.price);
  $("#pQty").textContent=qty;

  // ingredientes (string "a, b, c" ou array)
  const ingRaw = item.ingredients || item.ingredientes || "";
  let chipsHTML="";
  if (Array.isArray(ingRaw)) {
    chipsHTML = ingRaw.map(i=>`<span class="chip">${i}</span>`).join("");
  } else if (typeof ingRaw === "string" && ingRaw.trim()) {
    chipsHTML = ingRaw.split(/[,;|]/).map(s=>s.trim()).filter(Boolean).map(i=>`<span class="chip">${i}</span>`).join("");
  }
  $("#pIngredients").innerHTML = chipsHTML ? `<div class="chips">${chipsHTML}</div>` : "";

  // complements (se não for bebida/complemento)
  let html="";
  if(item.cat!=="Bebidas" && item.cat!=="Complementos"){
    html="<h4 style='margin:10px 0 6px 0'>Complementos</h4><div class='comps'>";
    complements.forEach(c=>{
      html+=`<label><span>${c.name} +${BRL(c.price)}</span><input type='checkbox' data-id='${c.id}' data-price='${c.price}'></label>`;
    });
    html+="</div>";
  }
  $("#compBox").innerHTML=html;

  $("#btnAddCart").onclick=()=>addCurrent({fromPopup:true});
  $("#dlgItem").showModal();
}

function changeQty(v){
  qty=Math.max(1,qty+v);
  $("#pQty").textContent=qty;
}

/* ====== CART ====== */
function addCurrent({fromPopup}={}){
  // só lê complements se veio do popup
  let comps=[];
  if(fromPopup){
    comps=[...document.querySelectorAll("#compBox input:checked")]
      .map(c=>({id:c.dataset.id,name:c.parentNode.querySelector("span").textContent.split("+")[0].trim(),price:+c.dataset.price}));
  }
  cart.push({...current,qty,comps});
  // fecha popup com segurança (só se estiver aberto)
  const dlg=$("#dlgItem"); if(fromPopup && dlg && dlg.open) dlg.close();
  renderCart(); toggleCart(true);
}

function renderCart(){
  $("#cartBadge").textContent=cart.length;
  $("#cartCount").textContent=cart.length+" itens";
  const box=$("#cartItems");box.innerHTML="";let total=0;
  cart.forEach(it=>{
    const extras=it.comps?.map(c=>c.name).join(", ");
    const val=(Number(it.price)+(it.comps||[]).reduce((a,b)=>a+b.price,0))*it.qty; total+=val;
    const row=document.createElement("div");row.className="cartItem";
    row.innerHTML=`<img src="${it.img}"><div class="info"><div class="name">${it.qty}× ${it.name}</div><div class="extras">${extras||""}</div></div><div class="price">${BRL(val)}</div>`;
    box.appendChild(row);
  });
  $("#grandTotal").textContent=BRL(total);
  $("#cartTotal").textContent=BRL(total);
  $("#trocoBox").style.display=$("#payMethod").value==="dinheiro"?"block":"none";
  document.getElementById("cartBar").style.display=cart.length? "flex":"none";
}

function toggleCart(o){$("#cartDrawer").classList.toggle("open",o)}
$("#payMethod").addEventListener("change",()=>renderCart());

/* ====== CHECKOUT ====== */
function finalizar(){
  if(!cart.length){alert("Carrinho vazio");return}
  const nome=$("#clienteNome").value.trim();
  const tel=$("#clienteTel").value.trim();
  const end=$("#clienteEnd").value.trim();
  if(!nome||!tel||!end){alert("Preencha nome, telefone e endereço");return}
  localStorage.setItem("cf_end",end);
  const pay=$("#payMethod").value;
  let msg=`*🍔 Pedido - Clena Foods*\n\n*Cliente:* ${nome}\n*Contato:* ${tel}\n*Endereço:* ${end}\n\n*Itens:*\n`;
  cart.forEach(it=>{
    const extras=it.comps?.map(c=>c.name).join(", ");
    const val=(Number(it.price)+(it.comps||[]).reduce((a,b)=>a+b.price,0))*it.qty;
    msg+=`• ${it.qty}× ${it.name} ${extras?`(${extras})`:""} — *${BRL(val)}*\n`;
  });
  msg+=`\n*Total:* ${$("#grandTotal").textContent}\n*Pagamento:* ${pay.toUpperCase()}`;
  if(pay==="dinheiro"&&$("#trocoVal").value) msg+=`\n*Troco para:* ${$("#trocoVal").value}`;
  if($("#obs").value) msg+=`\n*Obs:* ${$("#obs").value}`;
  // coloque aqui o número real do WhatsApp:
  window.open("https://wa.me/5577999999999?text="+encodeURIComponent(msg),"_blank");
}

/* start */
loadData();
</script>
</body>
</html>
